window.daysData = <%= Day.all.to_json %>;

function movingAverage(array, index, until) {
  var start = index + until + 1;
  if (index + until < 0) {
    start = 0;
  }
  var values = array.slice(start, index + 1).map(function(day) { return day.count; });
  return values.reduce(function(sum, n) { return sum + n; }, 0) / values.length;
}

var chartData = daysData.map(function(dayData, index, cD) {
  return {
    date: dayData.date,
    count: dayData.count,
    movingAvgOneWeek: movingAverage(cD, index, -7),
    movingAvgOneMonth: movingAverage(cD, index, -30)
  };
});

var chartWidth = 600;
var chartHeight = 400;
var barWidth = chartWidth / chartData.length;
var barHeight = d3.scale.linear()
  .range([chartHeight - 15, 0])
  .domain([0, d3.max(chartData, function(data) { return data.count; })]);

var chart = d3.select('#chart')
  .attr('width', chartWidth)
  .attr('height', chartHeight);

var bar = chart.selectAll('g').data(chartData).enter().append('g')
  .attr('transform', function(_data, i) { return 'translate(' + i * barWidth + ', 0)'; });

bar.append('rect')
  .attr('y', function(data) { return barHeight(data.count); })
  .attr('height', function(data) { return chartHeight - barHeight(data.count); })
  .attr('width', barWidth - 1);

bar.append('text')
  .attr('x', 2)
  .attr('y', function(data) { return barHeight(data.count) + 3; })
  .attr('width', barWidth - 1)
  .attr('dy', '.75em')
  .text(function(data) { return data.count; });

