(function() {

  function prepareDayDataForHC(attributeName) {
    return function(dayData) {
      var month0indexed = parseInt(dayData.date.substring(5, 7), 10) - 1;
      var day = parseInt(dayData.date.substring(8, 10), 10);
      return [Date.UTC(1970, month0indexed, day), dayData[attributeName]];
    }
  }

  function createSeriesDatForHc(seriesData, yearData) {
    seriesData.push({
      name: yearData.year,
      data: yearData.days.map(prepareDayDataForHC('count')),
      type: 'column',
      color: 'rgba(100, 100, 100, 0.5)',
      borderWidth: 0,
      pointPadding: 0,
      groupPadding: 0
    });
    seriesData.push({
      name: '' + yearData.year + ' 1-wk avg',
      data: yearData.days.map(prepareDayDataForHC('avg7')),
      type: 'line',
      color: 'rgba(150, 150, 150, 0.5)'
    });
    seriesData.push({
      name: '' + yearData.year + ' 1-mo avg',
      data: yearData.days.map(prepareDayDataForHC('avg28')),
      type: 'line',
      color: 'rgba(50, 250, 50, 0.7)'
    });
    seriesData.push({
      name: '' + yearData.year + ' 3-mo avg',
      data: yearData.days.map(prepareDayDataForHC('avg84')),
      type: 'line',
      color: 'rgba(50, 50, 250, 0.7)'
    });
    return seriesData;
  }

  function extractYearData(data) {
    return data.years.reduce(createSeriesDatForHc, []);
  }

  $(function() {

    $.ajax("/api/years.json").
      then(extractYearData).
      then(createChart).
      fail(console.error.bind(console));

    function createChart(seriesData) {
      $("#chart").highcharts({
        title: { text: 'eggs' },
        alignTicks: false,
        xAxis: {
          type: 'datetime',
          dateTimeLabelFormats: { // don't display the dummy year; it's part of data
            month: '%b',
            year: '%b'
          },
          title: { text: 'date' }
        },
        yAxis: {
          title: { text: 'eggs' },
          min: 0,
          endOnTick: false
        },
        tooltip: {
          headerFormat: '<b>{series.name}</b><br>', // fake the year
          pointFormat: '{point.x:%b}: {point.y:.0f}'
        },
        plotOptions: {
          series: {
            animation: false
          }
        },
        series: seriesData,
      });
    }

  });
})(this);
