(function(context) {

  function prepareDayDataForHC(attributeName) {
    return function(dayData) {
      var month0indexed = parseInt(dayData.date.substring(5, 7), 10) - 1;
      var day = parseInt(dayData.date.substring(8, 10), 10);
      return [Date.UTC(1970, month0indexed, day), dayData[attributeName]];
    }
  }

  function chartConfigForRawCount(yearData) {
    return {
      name: '' + yearData.year,
      data: yearData.days.map(prepareDayDataForHC('count')),
      type: 'scatter'
    };
  }

  function chartConfigFor1wkAvg(yearData) {
    return {
      name: '' + yearData.year,
      data: yearData.days.map(prepareDayDataForHC('avg7')),
      type: 'line'
    };
  }

  function chartConfigFor1moAvg(yearData) {
    return {
      name: '' + yearData.year,
      data: yearData.days.map(prepareDayDataForHC('avg28')),
      type: 'line'
    };
  }

  function chartConfigFor3moAvg(yearData) {
    return {
      name: '' + yearData.year,
      data: yearData.days.map(prepareDayDataForHC('avg84')),
      type: 'line'
    };
  }

  function createSeriesDataForHC(seriesData, yearData) {
    seriesData['raw'].push(chartConfigForRawCount(yearData));
    seriesData['1wk'].push(chartConfigFor1wkAvg(yearData));
    seriesData['1mo'].push(chartConfigFor1moAvg(yearData));
    seriesData['3mo'].push(chartConfigFor3moAvg(yearData));
    return seriesData;
  }

  function extractYearData(data) {
    return data.years.reduce(createSeriesDataForHC, {
      'raw': [],
      '1wk': [],
      '1mo': [],
      '3mo': []
    });
  }

  function chartOptions(config) {
    return {
      series: config.series,
      title: { text: config.title },
      alignTicks: false,
      xAxis: {
        type: 'datetime',
        dateTimeLabelFormats: { // don't display the dummy year; it's part of data
          month: '%b',
          year: '%b'
        },
        title: { text: 'date' }
      },
      yAxis: {
        title: { text: 'number of eggs' },
        min: 0,
        endOnTick: false
      },
      tooltip: {
        headerFormat: '<b>{series.name}</b><br>', // fake the year
        pointFormat: '{point.x:%b}: {point.y:.0f}'
      },
      plotOptions: {
        series: {
          animation: false
        }
      },
    };
  }

  $(function() {

    function createChart(seriesData) {
      $('#raw').highcharts(chartOptions({series: seriesData['raw'], title: 'egg counts'}));
      $('#1wk').highcharts(chartOptions({series: seriesData['1wk'], title: 'one week running average'}));
      $('#1mo').highcharts(chartOptions({series: seriesData['1mo'], title: 'one month running average'}));
      $('#3mo').highcharts(chartOptions({series: seriesData['3mo'], title: 'three month running average'}));
    }

    context.showChart = function() {
      $.ajax('/api/years.json')
        .then(extractYearData)
        .then(createChart)
        .fail(console.error.bind(console));
    };

  });
})(this);
