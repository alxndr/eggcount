(function() {

  function prepareDataForHC(dayData) {
    var month0indexed = parseInt(dayData.date.substring(5, 7), 10) - 1;
    var day = parseInt(dayData.date.substring(8, 10), 10);
    return [Date.UTC(1970, month0indexed, day), dayData.count];
  }

  function createSeriesDatForHc(seriesData, yearData) {
    seriesData.push({
      name: yearData.year,
      data: yearData.days.map(prepareDataForHC)
    });
    return seriesData;
  }

  function extractYearData(data) {
    return data.years.reduce(createSeriesDatForHc, []);
  }

  $(function() {

    $.ajax("/api/years.json").
      then(extractYearData).
      then(createChart).
      fail(console.error.bind(console));

    function createChart(seriesData) {
      $("#chart").highcharts({
        chart: { type: 'column' },
        title: { text: '' },
        xAxis: {
          type: 'datetime',
          dateTimeLabelFormats: { // don't display the dummy year
            month: '%b',
            year: '%b'
          },
          title: { text: 'date' }
        },
        yAxis: {
          title: { text: 'eggs' },
          min: 0
        },
        tooltip: {
          headerFormat: '<b>{series.name}</b><br>', // fake the year
          pointFormat: '{point.x:%b}: {point.y:.0f}'
        },
        plotOptions: {
          series: {
            borderWidth: 0
          }
        },

        series: seriesData,
      });
    }

  });
})(this);
