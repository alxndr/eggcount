<!DOCTYPE html>
<html>
  <head>
    <title>Eggcount</title>
    <style>
     .chart-placeholder {
       text-align: center;
     }

     .calendar {

       ul {
         margin: 0;
         padding: 0;
         list-style: none;
         font-size: 0.75em;
       } 

       .month {
         display: inline-block;
         vertical-align: top;

         ul {
           display: inline-block;
         }

         li {
           padding: 0.2em 0.4em;
           white-space: nowrap;
         }

         .modified {
           background: pink;
         }

         .date:after {
           content: ':\a0';
         }
       }

     }
  </style>
</head>
<body>

  <p class="chart-placeholder">
    <button onClick="this.remove(); showChart()">show chart</button>
  </p>

  <div id="charts">
    <div id="1wk"></div>
    <div id="1mo"></div>
    <div id="3mo"></div>
  </div>

  <script src="http://code.highcharts.com/4.2.2/highcharts.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.3/jquery.min.js"></script>
  <script>
   (function(context) {

     function prepareDayDataForHC(attributeName) {
       return function(dayData) {
         var month0indexed = parseInt(dayData.date.substring(5, 7), 10) - 1;
         var day = parseInt(dayData.date.substring(8, 10), 10);
         return [Date.UTC(1970, month0indexed, day), dayData[attributeName]];
       }
     }

     function chartConfigFor1wkAvg(yearData) {
       return {
         name: '' + yearData.year,
         data: yearData.days.map(prepareDayDataForHC('avg7')),
         type: 'line'
       };
     }

     function chartConfigFor1moAvg(yearData) {
       return {
         name: '' + yearData.year,
         data: yearData.days.map(prepareDayDataForHC('avg28')),
         type: 'line'
       };
     }

     function chartConfigFor3moAvg(yearData) {
       return {
         name: '' + yearData.year,
         data: yearData.days.map(prepareDayDataForHC('avg84')),
         type: 'line'
       };
     }

     function createSeriesDataForHC(seriesData, yearData) {
       seriesData['1wk'].push(chartConfigFor1wkAvg(yearData));
       seriesData['1mo'].push(chartConfigFor1moAvg(yearData));
       seriesData['3mo'].push(chartConfigFor3moAvg(yearData));
       return seriesData;
     }

     function extractYearData(data) {
       return data.years.reduce(createSeriesDataForHC, {
         '1wk': [],
         '1mo': [],
         '3mo': []
       });
     }

     function chartOptions(config) {
       return {
         series: config.series,
         title: { text: config.title },
         alignTicks: false,
         xAxis: {
           type: 'datetime',
           dateTimeLabelFormats: { // don't display the dummy year; it's part of data
             month: '%b',
             year: '%b'
           },
           title: { text: 'date' }
         },
         yAxis: {
           title: { text: 'number of eggs' },
           min: 0,
           endOnTick: false
         },
         tooltip: {
           headerFormat: '<b>{series.name}</b><br>', // fake the year
           pointFormat: '{point.x:%b}: {point.y:.0f}'
         },
         plotOptions: {
           series: {
             animation: false
           }
         },
       };
     }

     $(function() {

       function createChart(seriesData) {
         $('#1wk').highcharts(chartOptions({series: seriesData['1wk'], title: 'one week running average'}));
         $('#1mo').highcharts(chartOptions({series: seriesData['1mo'], title: 'one month running average'}));
         $('#3mo').highcharts(chartOptions({series: seriesData['3mo'], title: 'three month running average'}));
       }

       context.showChart = function() {
         $.ajax('/api/years.json')
           .then(extractYearData)
           .then(createChart)
           .fail(console.error.bind(console));
       };

     });
   })(this);
  </script>
</body>
</html>
